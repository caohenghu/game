!function(){"use strict";var t=function(t){var o=t.width,e=t.height,r=t.row,i=t.col;this.width=o,this.height=e,this.row=r,this.col=i,this.$el=document.createElement("div"),this.render()};t.prototype.render=function(){var t=this.$el,o=this.width,e=this.height,r=this.row,i=this.col,s=o/i,h=e/r;Object.assign(t.style,{position:"relative",display:"table",zIndex:1,pointerEvents:"none"});for(var a=0;a<r;a++){var n=document.createElement("div");Object.assign(n.style,{display:"table-row"});for(var c=0;c<i;c++){var l=document.createElement("div");Object.assign(l.style,{display:"table-cell",width:s+"px",height:h+"px",boxSizing:"border-box"}),0!==c&&Object.assign(l.style,{borderLeft:"1px solid #fff"}),0!==a&&Object.assign(l.style,{borderTop:"1px solid #fff"}),n.appendChild(l)}t.appendChild(n)}};var o=function(){this.arrow={left:void 0,top:void 0,right:void 0,bottom:void 0}};o.prototype.setArrow=function(t){var o=t.left,e=t.right,r=t.top,i=t.bottom;this.arrow={left:o,right:e,top:r,bottom:i}};var e=function(t){function o(){t.apply(this,arguments)}return t&&(o.__proto__=t),o.prototype=Object.create(t&&t.prototype),o.prototype.constructor=o,o}(o),r="ontouchstart"in document,i=r?"touchstart":"click",s={mousedown:r?"touchstart":"mousedown",mousemove:r?"touchmove":"mousemove",mouseup:r?"touchend":"mouseup"},h=function(t){function o(o){t.call(this);var e=o.sourcePos,r=o.width,i=o.height,s=o.img,h=o.imgWidth,a=o.imgHeight,n=o.parent;this.sourcePos=e,this.nowPos=[],this.img=s,this.imgWidth=h,this.imgHeight=a,this.width=r,this.height=i,this.parent=n,this.$el=document.createElement("canvas"),this.render(),this.bindEvent()}return t&&(o.__proto__=t),o.prototype=Object.create(t&&t.prototype),o.prototype.constructor=o,o.prototype.render=function(){var t=this.$el,o=this.img,e=this.sourcePos,r=this.imgWidth,i=this.imgHeight,s=this.width,h=this.height,a=t.getContext("2d");t.className="block",t.width=s*devicePixelRatio,t.height=h*devicePixelRatio,a.drawImage(o,e[0]*r,e[1]*i,r,i,0,0,t.width,t.height)},o.prototype.setPos=function(t,o){this.nowPos=[t,o],Object.assign(this.$el.style,{position:"absolute",left:this.nowPos[0]*this.width+"px",top:this.nowPos[1]*this.height+"px",width:this.width+"px",height:this.height+"px"})},o.prototype.bindEvent=function(){var t=this,o=this.$el;o.addEventListener(s.mousedown,(function(r){r.preventDefault();var i=o.offsetLeft,h=o.offsetTop,a=r.pageX||r.touches[0].pageX,n=r.pageY||r.touches[0].pageY,c=a,l=n,p=function(r){var s=r.pageX||r.touches[0].pageX,a=r.pageY||r.touches[0].pageY,n=s-c,p=a-l,w=i,d=h;t.arrow.left instanceof e&&n<0?w=i+Math.max(n,-t.width):t.arrow.right instanceof e&&n>0?w=i+Math.min(n,t.width):t.arrow.top instanceof e&&p<0?d=h+Math.max(p,-t.height):t.arrow.bottom instanceof e&&p>0&&(d=h+Math.min(p,t.height)),Object.assign(o.style,{left:w+"px",top:d+"px"})},w=function(r){var a=r.pageX||r.changedTouches[0].pageX,n=r.pageY||r.changedTouches[0].pageY,d=a-c,g=n-l,f=i,u=h;t.arrow.left instanceof e&&d<0?(f=i-t.width,t.setAllArrow("left")):t.arrow.right instanceof e&&d>0?(f=i+t.width,t.setAllArrow("right")):t.arrow.top instanceof e&&g<0?(u=h-t.height,t.setAllArrow("top")):t.arrow.bottom instanceof e&&g>0&&(u=h+t.height,t.setAllArrow("bottom")),Object.assign(o.style,{left:f+"px",top:u+"px"}),f===i&&u===h||t.parent.isSuccess(),document.removeEventListener(s.mousemove,p),document.removeEventListener(s.mouseup,w)};document.addEventListener(s.mousemove,p),document.addEventListener(s.mouseup,w)}))},o.prototype.setAllArrow=function(t){var o=null,e=this.arrow.left,r=this.arrow.right,i=this.arrow.top,s=this.arrow.bottom;"left"===t||"right"===t?("left"===t?((o=this.arrow.left).arrow.left&&(o.arrow.left.arrow.right=this),this.arrow.right&&(this.arrow.right.arrow.left=o),this.arrow.left=o.arrow.left,this.arrow.right=o,o.arrow.left=this,o.arrow.right=r,this.nowPos[0]--):((o=this.arrow.right).arrow.right&&(o.arrow.right.arrow.left=this),this.arrow.left&&(this.arrow.left.arrow.right=o),this.arrow.left=o,this.arrow.right=o.arrow.right,o.arrow.left=e,o.arrow.right=this,this.nowPos[0]++),o.arrow.top&&(o.arrow.top.arrow.bottom=this),o.arrow.bottom&&(o.arrow.bottom.arrow.top=this),this.arrow.top&&(this.arrow.top.arrow.bottom=o),this.arrow.bottom&&(this.arrow.bottom.arrow.top=o),this.arrow.top=o.arrow.top,this.arrow.bottom=o.arrow.bottom,o.arrow.top=i,o.arrow.bottom=s):("top"===t?((o=this.arrow.top).arrow.top&&(o.arrow.top.arrow.bottom=this),this.arrow.bottom&&(this.arrow.bottom.arrow.top=o),this.arrow.top=o.arrow.top,this.arrow.bottom=o,o.arrow.top=this,o.arrow.bottom=s,this.nowPos[1]--):((o=this.arrow.bottom).arrow.bottom&&(o.arrow.bottom.arrow.top=this),this.arrow.top&&(this.arrow.top.arrow.bottom=o),this.arrow.bottom=o.arrow.bottom,this.arrow.top=o,o.arrow.bottom=this,o.arrow.top=i,this.nowPos[1]++),o.arrow.left&&(o.arrow.left.arrow.right=this),o.arrow.right&&(o.arrow.right.arrow.left=this),this.arrow.left&&(this.arrow.left.arrow.right=o),this.arrow.right&&(this.arrow.right.arrow.left=o),this.arrow.left=o.arrow.left,this.arrow.right=o.arrow.right,o.arrow.left=e,o.arrow.right=r)},o}(o),a=function(t){var o=t.img,e=t.width,r=t.height,i=t.row,s=t.col;this.img=o,this.width=e,this.height=r,this.row=i,this.col=s,this.$el=document.createElement("div"),this.blocks=[],this.board=null,this.render(),this.renderBlocks(),this.resetBlocks(),this.renderBoard()};a.prototype.render=function(){Object.assign(this.$el.style,{position:"relative",width:this.width+"px",height:this.height+"px",marginTop:"30px",background:"#756780",border:"4px solid #fff"})},a.prototype.renderBoard=function(){var o={width:this.width,height:this.height,row:this.row,col:this.col};this.board=new t(o),this.$el.appendChild(this.board.$el)},a.prototype.renderBlocks=function(){for(var t=this.width,o=this.height,r=this.row,i=this.col,s=this.img,a=this.blocks,n=this.$el,c=t/i,l=o/r,p=s.width/i,w=s.height/r,d=0;d<r;d++)for(var g=0;g<i&&(d!==this.row-1||g!==this.col-1);g++){var f=new h({sourcePos:[g,d],width:c,height:l,img:s,imgWidth:p,imgHeight:w,parent:this});a.push(f),n.appendChild(f.$el)}a.push(new e)},a.prototype.isSuccess=function(){var t=!0;this.blocks.forEach((function(o){o instanceof h&&(o.sourcePos[0]!==o.nowPos[0]||o.sourcePos[1]!==o.nowPos[1])&&(t=!1)})),t&&setTimeout((function(){alert("挑战成功")}),300)},a.prototype.resetBlocks=function(){for(var t=this.blocks.slice(0,-1).sort((function(){return Math.random()>.5?1:-1})),o=[],e=0;e<this.row;e++){for(var r=[],i=0;i<this.col;i++){if(e===this.row-1&&i===this.col-1){r.push(this.blocks[this.blocks.length-1]);break}var s=t[0];s.setPos(i,e),r.push(s),t.shift()}o.push(r)}o.forEach((function(t,e){t.forEach((function(r,i){var s={left:t[i-1],right:t[i+1],top:(o[e-1]||[])[i],bottom:(o[e+1]||[])[i]};r.setArrow(s)}))}))},a.prototype.setSize=function(){var t=this.img.width/this.img.height,o=300,e=300;t>1?e=o/t:o=e*t,this.width=o,this.height=e},a.prototype.changeImage=function(t){this.img=t,this.setSize(),this.render(),this.clearBlocks(),this.renderBlocks(),this.resetBlocks(),this.clearBoard(),this.renderBoard()},a.prototype.changeLevel=function(t,o){this.row=t,this.col=o,this.clearBlocks(),this.renderBlocks(),this.resetBlocks(),this.clearBoard(),this.renderBoard()},a.prototype.clearBlocks=function(){var t=this;this.blocks.forEach((function(o){o instanceof h&&t.$el.removeChild(o.$el)})),this.blocks=[]},a.prototype.clearBoard=function(){this.board&&this.$el.removeChild(this.board.$el),this.board=null};!function(t,o){void 0===o&&(o={});var e=o.insertAt;if(t&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===e&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t))}}(".wrap{-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.wrap,.wrap .top{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center}.wrap .top{-webkit-box-pack:justify;justify-content:space-between;width:308px;height:160px}.wrap .preview{box-sizing:border-box;max-width:160px;max-height:160px;border:4px solid #fff}.wrap .btns{-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;justify-content:space-around;height:160px}.wrap .btn,.wrap .btns{display:-webkit-box;display:flex}.wrap .btn{position:relative;box-sizing:border-box;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;width:110px;height:36px;font-size:16px;color:#fff;background:#6aae78;border:2px solid #fff;border-radius:18px;-webkit-tap-highlight-color:transparent;-webkit-transition:all .1s;transition:all .1s}.wrap .btn.reset{background:#e6a153}.wrap .btn:active{-webkit-transform:scale(1.1);transform:scale(1.1)}.wrap input{position:absolute;width:100%;height:100%;opacity:0}");var n="https://i.loli.net/2020/02/08/8xtsWhDvRqUK57Y.jpg",c=document.querySelector(".app"),l={3:"一级难度",4:"二级难度",5:"三级难度"},p=Object.keys(l),w=3,d=new Image;d.onload=function(){var t={img:this,width:300,height:300,row:w,col:w},o=window.pingTu=new a(t);c.innerHTML='<div class="wrap"><div class="top"><img class="preview"><div class="btns"><div class="btn img"><span>更换图片</span> <input type="file" accept=".jpg,.jpge,.png"></div><span class="btn level">一级难度</span> <span class="btn reset">重新开始</span></div></div></div>';var e=c.querySelector(".wrap"),r=c.querySelector(".preview"),s=c.querySelector(".img"),h=c.querySelector("input"),d=c.querySelector(".level"),g=c.querySelector(".reset");e.appendChild(o.$el),r.src=n,h.addEventListener("change",(function(t){!function(t,o,e){var r=new FileReader;r.onload=function(t){var r=t.target.result,i=new Image;i.onload=function(){o.changeImage(this)},i.src=r,e.src=r},r.readAsDataURL(t)}(t.target.files[0],o,r)})),s.addEventListener(i,(function(t){t.stopPropagation()})),d.addEventListener(i,(function(t){t.stopPropagation(),setTimeout((function(){!function(t,o){++w>Math.max.apply(Math,p)&&(w=Math.min.apply(Math,p));t.changeLevel(w,w),o.innerText=l[w]}(o,d)}),100)})),g.addEventListener(i,(function(t){t.stopPropagation(),o.resetBlocks()}))},d.src=n}();
